"use strict";var WASM_PATH="btb.wasm";var ERROR=document.getElementById("ee");var SUPPORT=document.getElementById("es");var CANVAS=document.getElementById("a");function e(str){CANVAS.style.display="none";ERROR.style.display="";throw str}var P_PALETTE_SIZE=16;var P_OUTPUT_BUFFER_TYPE_VERTEX_PALETTE=1;var P_OUTPUT_BUFFER_TYPE_VERTEX_MONO=2;var P_OUTPUT_BUFFER_COMMAND_SET_PALETTE=1;var P_OUTPUT_BUFFER_COMMAND_CLEAR_COLOR=2;var P_OUTPUT_BUFFER_COMMAND_UPLOAD_MESH=3;var P_OUTPUT_BUFFER_COMMAND_RENDER_MESH=4;var P_OUTPUT_BUFFER_COMMAND_UPDATE_MESH=5;var P_OUTPUT_BUFFER_COMMAND_DELETE_MESH=6;var P_OUTPUT_BUFFER_COMMAND_SET_TRANSFORMATION=7;var P_OUTPUT_BUFFER_COMMAND_DEBUG_THROW=240;var P_OUTPUT_BUFFER_COMMAND_DEBUG_PRINT=241;var P_INPUT_BUFFER_COMMAND_SET_DPAD=1;var P_INPUT_BUFFER_COMMAND_SET_CANVAS_SIZE=4;var VERT_SHADER=["uniform float alpha;","uniform mat4 globalTransform;","uniform mat4 localTransform;","","uniform vec4 palette[0x10];","","attribute vec2 vPosition;","attribute float vPaletteIndex;","","varying vec4 fColor;","","void main() {","  gl_Position = globalTransform * localTransform * vec4(vPosition, 0, 1);","  fColor = palette[int(vPaletteIndex)];","  fColor.a = alpha;","}"].join("\n");var FRAG_SHADER=["precision mediump float;","","varying vec4 fColor;","","void main() {","  gl_FragColor = fColor;","}"].join("\n");var VERT_SHADER_MONO=["uniform float alpha;","uniform mat4 globalTransform;","uniform mat4 localTransform;","","uniform vec4 color;","","attribute vec2 vPosition;","","varying vec4 fColor;","","void main() {","  gl_Position = globalTransform * localTransform * vec4(vPosition, 0, 1);","  fColor = color;","  fColor.a = alpha;","}"].join("\n");var FRAG_SHADER_MONO=["precision mediump float;","","varying vec4 fColor;","","void main() {","  gl_FragColor = fColor;","}"].join("\n");function createShader(gl,vertSource,fragSource){var prog=gl.createProgram();var vert=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(vert,vertSource);gl.compileShader(vert);if(!gl.getShaderParameter(vert,gl.COMPILE_STATUS)){e(gl.getShaderInfoLog(vert))}var frag=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(frag,fragSource);gl.compileShader(frag);if(!gl.getShaderParameter(frag,gl.COMPILE_STATUS)){e(gl.getShaderInfoLog(frag))}gl.attachShader(prog,vert);gl.attachShader(prog,frag);gl.linkProgram(prog);gl.deleteShader(vert);gl.deleteShader(frag);if(!gl.getProgramParameter(prog,gl.LINK_STATUS)){e(gl.getProgramInfoLog(prog))}return prog}function main(){var supported=true;if(!("WebAssembly"in window)){supported=false}else if(!("fetch"in window)){supported=false}window["gl"]=CANVAS.getContext("webgl")||CANVAS.getContext("webgl-experimental");if(!gl){support=false}if(!supported){CANVAS.style.display="none";SUPPORT.style.display="";throw"Unsupported Device."}window["wasm"]=null;fetch(WASM_PATH).then(function(res){if(!res.ok){e("Could not fetch '"+WASM_PATH+"'.")}return res.arrayBuffer()}).then(function(buffer){return WebAssembly.instantiate(buffer,{})}).then(function(module){wasm=module;requestAnimationFrame(frame)});var paletteShader=createShader(gl,VERT_SHADER,FRAG_SHADER);var monoShader=createShader(gl,VERT_SHADER_MONO,FRAG_SHADER_MONO);window["glShaders"]={palette:{id:paletteShader,aPosition:gl.getAttribLocation(paletteShader,"vPosition"),aPaletteIndex:gl.getAttribLocation(paletteShader,"vPaletteIndex"),uPalette:gl.getUniformLocation(paletteShader,"palette"),uAlpha:gl.getUniformLocation(paletteShader,"alpha"),uGlobalT:gl.getUniformLocation(paletteShader,"globalTransform"),uLocalT:gl.getUniformLocation(paletteShader,"localTransform")},mono:{id:monoShader,aPosition:gl.getAttribLocation(monoShader,"vPosition"),uColor:gl.getUniformLocation(monoShader,"color"),uAlpha:gl.getUniformLocation(monoShader,"alpha"),uGlobalT:gl.getUniformLocation(monoShader,"globalTransform"),uLocalT:gl.getUniformLocation(monoShader,"localTransform")}};gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);window.addEventListener("keydown",function(e){if(e.key=="w"||e.key=="ArrowUp"){keys.up=true}else if(e.key=="s"||e.key=="ArrowDown"){keys.down=true}else if(e.key=="a"||e.key=="ArrowLeft"){keys.left=true}else if(e.key=="d"||e.key=="ArrowRight"){keys.right=true}});window.addEventListener("keyup",function(e){if(e.key=="w"||e.key=="ArrowUp"){keys.up=false}else if(e.key=="s"||e.key=="ArrowDown"){keys.down=false}else if(e.key=="a"||e.key=="ArrowLeft"){keys.left=false}else if(e.key=="d"||e.key=="ArrowRight"){keys.right=false}})}var lastFrameTime=0;var firstFrame=true;var pointerTable=null;var palette=new Float32Array(P_PALETTE_SIZE*4);var globalTransformation=new Float32Array(16);var glSlots=Array(65536);var keys={up:false,down:false,left:false,right:false};var lastKeysWord=0;var lastCanvasWidth=0;var lastCanvasHeight=0;function frame(){var now=performance.now();var m32=null;var ioBufferPointer=null;var ioBufferBase=null;var ioBufferTop=null;var currentTop=null;if(!firstFrame){m32=new Uint32Array(wasm.instance.exports.memory.buffer);ioBufferPointer=m32[pointerTable]/4;ioBufferBase=ioBufferPointer+1;ioBufferTop=0;var keysWord=(keys.up?255:0)<<0|(keys.down?255:0)<<8|(keys.left?255:0)<<16|(keys.right?255:0)<<24;if(keysWord!==lastKeysWord){m32[ioBufferBase+ioBufferTop++]=P_INPUT_BUFFER_COMMAND_SET_DPAD;m32[ioBufferBase+ioBufferTop++]=keysWord;lastKeysWord=keysWord}var newCanvasWidth=CANVAS.clientWidth;var newCanvasHeight=CANVAS.clientHeight;if(newCanvasWidth!=lastCanvasWidth||newCanvasHeight!=lastCanvasHeight){CANVAS.width=newCanvasWidth;CANVAS.height=newCanvasHeight;if(newCanvasWidth>65535||newCanvasHeight>65535){e("Canvas width or height exceeded FFFF.")}m32[ioBufferBase+ioBufferTop++]=P_INPUT_BUFFER_COMMAND_SET_CANVAS_SIZE;m32[ioBufferBase+ioBufferTop++]=(newCanvasWidth&65535)<<0|(newCanvasHeight&65535)<<16;lastCanvasWidth=newCanvasWidth;lastCanvasHeight=newCanvasHeight}m32[ioBufferPointer]=ioBufferTop}pointerTable=wasm.instance.exports.pHtml5Frame(now)/4;if(pointerTable%1!=0){e("Unaligned pointer table: "+(pointerTable*4).toString(16).toUpperCase())}gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight);var currentShader="none";m32=new Uint32Array(wasm.instance.exports.memory.buffer);ioBufferPointer=m32[pointerTable]/4;ioBufferBase=ioBufferPointer+1;ioBufferTop=m32[ioBufferPointer];currentTop=0;while(ioBufferTop>currentTop){var c=m32[ioBufferBase+currentTop++];switch(c&255){case P_OUTPUT_BUFFER_COMMAND_SET_PALETTE:{var pointer=m32[ioBufferBase+currentTop++]/4;if(pointer%1!=0){e("Unaligned palette pointer.")}for(var i=0;i<P_PALETTE_SIZE;i++){var color=m32[pointer+i];palette[i*4+0]=(color>>0&255)/255;palette[i*4+1]=(color>>8&255)/255;palette[i*4+2]=(color>>16&255)/255;palette[i*4+3]=(color>>24&255)/255}break};case P_OUTPUT_BUFFER_COMMAND_CLEAR_COLOR:{var index=c>>8&15;gl.clearColor(palette[index*4+0],palette[index*4+1],palette[index*4+2],palette[index*4+3]);gl.clear(gl.COLOR_BUFFER_BIT);break};case P_OUTPUT_BUFFER_COMMAND_UPDATE_MESH:case P_OUTPUT_BUFFER_COMMAND_UPLOAD_MESH:{var typeExtra=c>>8&255;var type=typeExtra>>0&15;var extra=typeExtra>>4&15;var index=c>>16&65535;var vertexNumber=m32[ioBufferBase+currentTop++];var meshPointer=m32[ioBufferBase+currentTop++];var buffer=null;if((c&255)==P_OUTPUT_BUFFER_COMMAND_UPLOAD_MESH){if(glSlots[index]){e("Attempting to upload buffer into filled slot.")}buffer=gl.createBuffer()}else{if(!glSlots[index]){e("Attempting to update into unfilled slot.")}buffer=glSlots[index]}var vertexSize=type==P_OUTPUT_BUFFER_TYPE_VERTEX_PALETTE?12:8;gl.bindBuffer(gl.ARRAY_BUFFER,buffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(wasm.instance.exports.memory.buffer,meshPointer,vertexNumber*vertexSize/4),gl.DYNAMIC_DRAW);glSlots[index]=buffer;break};case P_OUTPUT_BUFFER_COMMAND_RENDER_MESH:{var typeExtra=c>>8&255;var type=typeExtra>>0&15;var extra=typeExtra>>4&15;var index=c>>16&65535;var startIndex=m32[ioBufferBase+currentTop++];var lengthAlpha=m32[ioBufferBase+currentTop++];var length=lengthAlpha&65535;var alpha=lengthAlpha>>16&65535;var transformPointer=m32[ioBufferBase+currentTop++];if(transformPointer/4%1!=0){e("Unaligned local transformation.")}if(!glSlots[index]){e("Attempting to render an unfilled slot.")}var localTransformation=new Float32Array(wasm.instance.exports.memory.buffer,transformPointer,16);var buffer=glSlots[index];gl.bindBuffer(gl.ARRAY_BUFFER,buffer);var gTrans;var lTrans;var uAlpha;if(type==P_OUTPUT_BUFFER_TYPE_VERTEX_PALETTE){gTrans=glShaders.palette.uGlobalT;lTrans=glShaders.palette.uLocalT;uAlpha=glShaders.palette.uAlpha;if(currentShader!=="palette"){currentShader="palette";gl.useProgram(glShaders.palette.id);gl.enableVertexAttribArray(glShaders.palette.aPosition);gl.enableVertexAttribArray(glShaders.palette.aPaletteIndex)}gl.vertexAttribPointer(glShaders.palette.aPosition,2,gl.FLOAT,false,12,0);gl.vertexAttribPointer(glShaders.palette.aPaletteIndex,1,gl.FLOAT,false,12,8);gl.uniform4fv(glShaders.palette.uPalette,palette)}else if(type==P_OUTPUT_BUFFER_TYPE_VERTEX_MONO){gTrans=glShaders.mono.uGlobalT;lTrans=glShaders.mono.uLocalT;uAlpha=glShaders.mono.uAlpha;if(currentShader!=="mono"){currentShader="mono";gl.useProgram(glShaders.mono.id);gl.enableVertexAttribArray(glShaders.mono.aPosition)}gl.vertexAttribPointer(glShaders.mono.aPosition,2,gl.FLOAT,false,8,0);gl.uniform4f(glShaders.mono.uColor,palette[extra*4+0],palette[extra*4+1],palette[extra*4+2],palette[extra*4+3])}gl.uniform1f(uAlpha,alpha/65535);gl.uniformMatrix4fv(gTrans,false,globalTransformation);gl.uniformMatrix4fv(lTrans,false,localTransformation);gl.drawArrays(gl.TRIANGLES,startIndex,length);break};case P_OUTPUT_BUFFER_COMMAND_DELETE_MESH:{var index=c>>16&65535;if(!glSlots[index]){e("Attempting to delete and unfilled slot.")}var buffer=glSlots[index];gl.deleteBuffer(buffer);break};case P_OUTPUT_BUFFER_COMMAND_SET_TRANSFORMATION:{var pointer=m32[ioBufferBase+currentTop++]/4;if(pointer%1!=0){e("Unaligned global transformation.")}var f32=new Float32Array(wasm.instance.exports.memory.buffer);for(var i=0;i<16;i++){globalTransformation[i]=f32[pointer+i]}break};case P_OUTPUT_BUFFER_COMMAND_DEBUG_THROW:case P_OUTPUT_BUFFER_COMMAND_DEBUG_PRINT:{var messagePointer=m32[ioBufferBase+currentTop++];var m8=new Uint8Array(wasm.instance.exports.memory.buffer);var message="";for(var p=messagePointer;m8[p]!=0;p++){message+=String.fromCharCode(m8[p])}if((c&255)==P_OUTPUT_BUFFER_COMMAND_DEBUG_THROW){e(message)}else{console.log(message)}break};default:e("Unknown command "+(c&255).toString(16))}}if(ioBufferTop!==currentTop){e("IO buffer desynchronization.")}requestAnimationFrame(frame);firstFrame=false}window.onload=main;
